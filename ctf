#! /usr/bin/env python
# -*- encoding: utf-8 -*-

import os
import codecs
import argparse
import getpass

from nizkctf.cli import scoreboard
from nizkctf.cli import challenges
from nizkctf.cli import team
from nizkctf.repohost import RepoHost
from nizkctf.subrepo import SubRepo

def read_opt(msg, opts):
    while True:
        inp = raw_input(msg)
        if inp.strip() in opts:
            return inp.strip()

def read_auth(opt):
    while True:
        if opt == '1':
            print('Enter your username and password:')
            username = raw_input('Username: ')
            password = getpass.getpass('Password: ')
            RepoHost.login(username=username, password=password)
            return True
        elif opt == '2':
            print('Enter your auth token:')
            token = raw_input('Token: ')
            RepoHost.login(token=token)
            return True

def cmd_scoreboard(args):
    with open('accepted-submissions.json', 'r') as f:
        ranking, submissions = scoreboard.rank(f)
    scoreboard.pprint(ranking, top=args.top)

    if args.chart:
        scoreboard.plot(ranking, submissions)

def cmd_register(args):
    team.register(args.name)

def cmd_login(args):
    if args.token != None:
        RepoHost.login(token=args.token)
    else:
        read_auth('1')
    print('User successfully authenticated')
    print('Cloning submissions repository')
    SubRepo.clone()

def cmd_init(args):
    print('NIZKCTF initializing your environment.')
    print('First of all, we need your github/gitlab credentials:')
    print('[1] auth via username / password')
    print('[2] auth with generated token')
    opt = read_opt('>> ', set(['1','2']))
    print('')

    read_auth(opt)
    print('')

    print('Cloning submissions repository')
    SubRepo.clone()

    print('Do you want to register a new team? [y/n]')
    opt = read_opt('>> ', set(['y','n']))
    if opt == 'y':
        print('Enter your team name:')
        team_name = raw_input('>> ')
        team.register(team_name)
    print('')

    print('We are all set!')

def cmd_submit(args):
    print('Checking flag: %s'%(args.flag))
    thisdir = os.path.dirname(os.path.realpath(__file__))
    challf = os.path.join(thisdir, 'challenges/challenges.json')
    with codecs.open(challf, 'r', 'utf8') as f:
        print(challenges.check_flag(f, args.id, args.flag))

def main():
    commands = {
        'init': cmd_init,
        'login': cmd_login,
        'score': cmd_scoreboard,
        'register': cmd_register,
        'submit': cmd_submit,
    }

    parser = argparse.ArgumentParser(description='nizk CTF cli')
    subparsers = parser.add_subparsers(help='command help')

    parser_init = subparsers.add_parser('init', help='init ctf environment')
    parser_init.set_defaults(command='init')

    parser_login = subparsers.add_parser('login', help='authenticate in gitlab/github')
    parser_login.set_defaults(command='login')
    parser_login.add_argument('--token', type=str, default=None,
                              metavar='TOKEN',
                              help='use token auth instead of username/password')

    parser_score = subparsers.add_parser('score', help='scoreboard help')
    parser_score.set_defaults(command='score')
    parser_score.add_argument('--top', type=int,
                              default=0, metavar='N',
                              help='size of ranking to display')
    parser_score.add_argument('--chart', type=bool,
                              default=False, metavar='T/F',
                              help='display chart (true or false).')

    parser_register = subparsers.add_parser('register', help='register a new team')
    parser_register.set_defaults(command='register')
    parser_register.add_argument('name', metavar='NAME', help='team name')

    parser_submit = subparsers.add_parser('submit', help='submit a flag')
    parser_submit.set_defaults(command='submit')
    parser_submit.add_argument('id', metavar='CHALL_ID', help='challenge id')
    parser_submit.add_argument('flag', metavar='FLAG', help='flag')

    args = parser.parse_args()
    commands[args.command](args)

if __name__ == '__main__':
    main()
