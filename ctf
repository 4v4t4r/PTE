#! /usr/bin/env python
# -*- encoding: utf-8 -*-

import argparse
import getpass

from nizkctf.cli import scoreboard
from nizkctf.cli import team
from nizkctf.repohost import RepoHost

def read_opt(msg, opts):
    while True:
        inp = raw_input(msg)
        if inp.strip() in opts:
            return inp.strip()

def read_auth(opt):
    while True:
        if opt == '1':
            print('Enter your username and password:')
            username = raw_input('Username: ')
            password = getpass.getpass('Password: ')
            try:
                RepoHost.login(username=username, password=password)
                return True
            except Exception as e:
                print('Could not get access token')
                print('    %s'%(e))
        elif opt == '2':
            print('Enter your auth token:')
            token = raw_input('Token: ')
            try:
                RepoHost.login(token=token)
            except Exception as e:
                print('Could not connect using provided token')
                print('    %s'%(e))

def cmd_scoreboard(args):
    with open('accepted-submissions.json', 'r') as f:
        ranking, submissions = scoreboard.rank(f)
    scoreboard.pprint(ranking, top=args.top)

    if args.chart:
        scoreboard.plot(ranking, submissions)

def cmd_register(args):
    team.register(args.name)

def cmd_auth(args):
    print('auth user')

def cmd_init(args):
    print('NIZKCTF initializing your environment.')
    print('First of all, we need your github/gitlab credentials:')
    print('[1] auth via username / password')
    print('[2] auth with generated token')
    opt = read_opt('>> ', set(['1','2']))
    print('')

    read_auth(opt)
    print('')

    print('Do you want to register a new team? [y/n]')
    opt = read_opt('>> ', set(['y','n']))
    if opt == 'y':
        print('Enter your team name:')
        team_name = raw_input('>> ')
        team.register(team_name)
    print('')

    print('We are all set!')

def main():
    commands = {
        'init': cmd_init,
        'auth': cmd_auth,
        'score': cmd_scoreboard,
        'register': cmd_register,
    }

    parser = argparse.ArgumentParser(description='nizk CTF cli')
    subparsers = parser.add_subparsers(help='command help')

    parser_init = subparsers.add_parser('init', help='init ctf environment')
    parser_init.set_defaults(command='init')

    parser_auth = subparsers.add_parser('auth', help='authenticate in gitlab/github')
    parser_auth.set_defaults(command='auth')

    parser_score = subparsers.add_parser('score', help='scoreboard help')
    parser_score.set_defaults(command='score')
    parser_score.add_argument('--top', type=int,
                              default=0, metavar='N',
                              help='size of ranking to display')
    parser_score.add_argument('--chart', type=bool,
                              default=False, metavar='T/F',
                              help='display chart (true or false).')

    parser_register = subparsers.add_parser('register', help='register a new team')
    parser_register.set_defaults(command='register')
    parser_register.add_argument('name', metavar='NAME', help='team name')

    args = parser.parse_args()
    commands[args.command](args)

if __name__ == '__main__':
    main()
